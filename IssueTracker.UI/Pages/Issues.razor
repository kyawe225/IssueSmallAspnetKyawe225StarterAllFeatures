@page "/issues"
@using IssueTracker.UI.Models
@using IssueTracker.UI.Services
@inject IIssueService IssueService
@inject NavigationManager Navigation
@inject ILoadingService LoadingService

<PageTitle>Issues</PageTitle>

<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Issues</h1>
                <button class="btn btn-primary" @onclick="NavigateToCreate">
                    <i class="bi bi-plus"></i> Create Issue
                </button>
            </div>

            @if (isLoading)
            {
                <LoadingCard LoadingText="Loading Issues" SubText="Fetching your issues from the server..." />
            }
            else if (issues?.Items?.Any() == true)
            {
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Status</th>
                                        <th>Due Date</th>
                                        <th>Created At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var issue in issues.Items)
                                    {
                                        <tr>
                                            <td>
                                                <strong>@issue.Title</strong>
                                                <br />
                                                <small class="text-muted">@issue.Description</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-@GetStatusBadgeClass(issue.Status)">
                                                    @issue.Status
                                                </span>
                                            </td>
                                            <td>@issue.DueDate.ToString("MMM dd, yyyy")</td>
                                            <td>@issue.CreatedAt.ToString("MMM dd, yyyy HH:mm")</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-1" 
                                                        @onclick="() => ViewIssue(issue.Id)">
                                                    <i class="bi bi-eye"></i> View
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                                        @onclick="() => EditIssue(issue.Id)">
                                                    <i class="bi bi-pencil"></i> Edit
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        @onclick="() => DeleteIssue(issue.Id)">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                Showing @issues.Items.Count of @issues.TotalCount issues
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                        disabled="@(currentPage <= 1)" 
                                        @onclick="PreviousPage">
                                    <i class="bi bi-chevron-left"></i> Previous
                                </button>
                                <span class="mx-2">Page @currentPage</span>
                                <button class="btn btn-sm btn-outline-secondary" 
                                        disabled="@(currentPage * pageSize >= issues.TotalCount)" 
                                        @onclick="NextPage">
                                    Next <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <h4>No Issues Found</h4>
                    <p>There are no issues to display. <a href="/issues/create">Create your first issue</a>.</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private IndexModel<Issue>? issues;
    private bool isLoading = true;
    private int currentPage = 1;
    private int pageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadIssues();
    }

    private async Task LoadIssues()
    {
        isLoading = true;
        LoadingService.ShowLoading("Loading Issues...");
        
        try
        {
            var data = await IssueService.GetIssuesAsync(currentPage, pageSize);
            issues = data.Data;
        }
        finally
        {
            isLoading = false;
            LoadingService.HideLoading();
        }
    }

    private async Task NextPage()
    {
        currentPage++;
        await LoadIssues();
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadIssues();
        }
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/issues/create");
    }

    private void ViewIssue(string id)
    {
        Navigation.NavigateTo($"/issues/{id}");
    }

    private void EditIssue(string id)
    {
        Navigation.NavigateTo($"/issues/edit/{id}");
    }

    private async Task DeleteIssue(string id)
    {
        if (confirm($"Are you sure you want to delete this issue?"))
        {
            await IssueService.DeleteIssueAsync(id);
            await LoadIssues();
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        var lowerStatus = status?.ToLower();
        if (lowerStatus == "open")
            return "success";
        if (lowerStatus == "in progress")
            return "warning";
        if (lowerStatus == "closed")
            return "secondary";
        if (lowerStatus == "pending")
            return "info";
        return "primary";
    }

    private bool confirm(string message)
    {
        return true;
    }
}