@page "/issues/{Id}"
@using IssueTracker.UI.Models
@using IssueTracker.UI.Services
@using Microsoft.JSInterop
@inject NavigationManager Navigation
@inject IIssueService IssueService
@inject IJSRuntime JSRuntime

<PageTitle>Issue Details</PageTitle>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            @if (isLoading)
            {
                <LoadingCard LoadingText="Loading Issue Details" SubText="Retrieving issue information..." />
            }
            else if (issue != null)
            {
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">@issue.Title</h3>
                        <span class="badge bg-@GetStatusBadgeClass(issue.Status) fs-6">
                            @issue.Status
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5><i class="bi bi-file-text"></i> Description</h5>
                                <p class="text-muted">@issue.Description</p>
                                
                                <hr />
                                
                                <div class="row">
                                    <div class="col-6">
                                        <strong><i class="bi bi-hash"></i> Issue ID:</strong><br />
                                        <small class="text-muted font-monospace">@issue.Id</small>
                                    </div>
                                    <div class="col-6">
                                        <strong><i class="bi bi-flag"></i> Status:</strong><br />
                                        <span class="badge bg-@GetStatusBadgeClass(issue.Status)">@issue.Status</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title"><i class="bi bi-info-circle"></i> Issue Information</h6>
                                        
                                        <div class="mb-3">
                                            <strong><i class="bi bi-calendar-date"></i> Due Date:</strong><br />
                                            <span class="@GetDueDateClass()">
                                                @issue.DueDate.ToString("MMMM dd, yyyy")
                                            </span>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong><i class="bi bi-clock"></i> Created At:</strong><br />
                                            <span class="text-muted">@issue.CreatedAt.ToString("MMMM dd, yyyy HH:mm")</span>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong><i class="bi bi-hourglass-split"></i> Days Until Due:</strong><br />
                                            <span class="@GetDaysUntilDueClass()">
                                                @GetDaysUntilDue() days
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr />
                        
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-secondary" @onclick="BackToList">
                                <i class="bi bi-arrow-left"></i> Back to Issues
                            </button>
                            <div>
                                <button class="btn btn-primary me-2" @onclick="EditIssue">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-danger" @onclick="DeleteIssue">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning">
                    <h4>Issue Not Found</h4>
                    <p>The requested issue could not be found.</p>
                    <button class="btn btn-primary" @onclick="BackToList">
                        <i class="bi bi-arrow-left"></i> Back to Issues
                    </button>
                </div>
            }
        </div>
    </div>
</div>


@code{
    [Parameter] public string Id { get; set; } = string.Empty;
    
    private Issue? issue;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadIssue();
    }

    private async Task LoadIssue()
    {
        isLoading = true;
        var data = await IssueService.GetIssueByIdAsync(Id);
        issue = data.Data;
        isLoading = false;
    }

    private void BackToList()
    {
        Navigation.NavigateTo("/issues");
    }

    private void EditIssue()
    {
        Navigation.NavigateTo($"/issues/edit/{Id}");
    }

private async Task DeleteIssue()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete the issue '{issue?.Title}'?");
        if (confirmed)
        {
            await IssueService.DeleteIssueAsync(Id);
            Navigation.NavigateTo("/issues");
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        var lowerStatus = status?.ToLower();
        if (lowerStatus == "open")
            return "success";
        if (lowerStatus == "in progress")
            return "warning";
        if (lowerStatus == "closed")
            return "secondary";
        if (lowerStatus == "pending")
            return "info";
        return "primary";
    }

    public string GetDueDateClass()
    {
        if (issue == null) return "";
        
        var daysUntilDue = (issue.DueDate.Date - DateTime.Today).Days;
        if (daysUntilDue < 0) return "text-danger";
        if (daysUntilDue <= 3) return "text-warning";
        return "text-success";
    }

    private string GetDaysUntilDueClass()
    {
        if (issue == null) return "";
        var daysUntilDue = GetDaysUntilDue();
        if (daysUntilDue < 0) return "text-danger fw-bold";
        if (daysUntilDue <= 3) return "text-warning fw-bold";
        return "text-success";
    }


    private int GetDaysUntilDue()
    {
        if (issue == null) return 0;
        return (issue.DueDate.Date - DateTime.Today).Days;
    }
}
